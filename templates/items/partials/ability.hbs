<div class="ability-layout">
  <nav class="ability-tabs tabs" data-group="ability">
    <a class="item" data-tab="description">{{localize "RMRPG.Item.Ability.DescriptionTab"}}</a>
    <a class="item" data-tab="details">{{localize "RMRPG.Item.Ability.DetailsTab"}}</a>
    <a class="item" data-tab="additional-settings">{{localize "RMRPG.Item.Ability.AdditionalSettings.Tab"}}</a>
  </nav>
  <div class="ability-tab-content">
    <div class="tab" data-group="ability" data-tab="description">
      <div class="description-block">
        {{editor system.description target="system.description" button=true editable=editable engine="prosemirror"}}
      </div>
    </div>
    <div class="tab" data-group="ability" data-tab="details">
      <div class="ability-details">
        <section class="ability-section ability-section--compact">
          <div class="ability-inline-select-row">
            <div class="ability-section-title">{{localize "RMRPG.Item.Ability.CastingTime.Title"}}</div>
            <select name="system.ability.castingTime">
              {{selectOptions abilityCastingTimeOptions selected=ability.castingTime valueAttr="value" labelAttr="label"}}
            </select>
          </div>
          <div class="ability-inline-select-row">
            <div class="ability-section-title">{{localize "RMRPG.Item.Ability.CastingCost.Title"}}</div>
            <select name="system.ability.castingCost">
              {{selectOptions abilityCastingCostOptions selected=ability.castingCost valueAttr="value" labelAttr="label"}}
            </select>
          </div>
        </section>

        <section class="ability-section">
          <div class="ability-section-title">{{localize "RMRPG.Item.Ability.Categories.Title"}}</div>
          {{#if abilityCategoryLimitExceeded}}
          <div class="ability-section-warning">{{localize "RMRPG.Item.Ability.Categories.LimitExceededWarning"}}</div>
          {{/if}}
          <div class="ability-category-table">
            {{#if ability.categories.length}}
            {{#each ability.categories}}
            <div class="ability-category-row" data-index="{{@index}}" data-id="{{this.id}}" data-uuid="{{this.uuid}}">
              <img class="item-icon" src="{{this.img}}" title="{{this.name}}" />
              <div class="ability-category-main">
                <button type="button" class="item-name" data-action="ability-category-open" data-id="{{this.id}}" data-uuid="{{this.uuid}}">
                  {{this.name}}
                </button>
              </div>
              <span class="ability-category-type" title="{{this.tooltip}}">{{this.categoryLabel}}</span>
              <span class="ability-category-cost">{{this.cost}}</span>
              <button
                type="button"
                class="item-delete"
                data-action="ability-category-remove"
                data-index="{{@index}}"
                aria-label="{{localize 'RMRPG.Item.Ability.Remove'}}"
                title="{{localize 'RMRPG.Item.Ability.Remove'}}"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
            {{/each}}
            {{/if}}
          </div>
          <div class="ability-category-actions">
            <button
              type="button"
              class="ability-add"
              data-action="ability-category-add"
            >
              <i class="fas fa-plus"></i>
              {{localize "RMRPG.Item.Ability.Categories.Add"}}
            </button>
          </div>
        </section>

        <section class="ability-section">
          <div class="ability-section-title">{{localize "RMRPG.Item.Ability.Characteristics.Title"}}</div>
          {{#if abilityCharacteristicLimitExceeded}}
          <div class="ability-section-warning">{{localize "RMRPG.Item.Ability.Characteristics.LimitExceededWarning"}}</div>
          {{/if}}
          {{#if abilityHasOverRankingCharacteristics}}
          <div class="ability-section-warning">{{localize "RMRPG.Item.Ability.Characteristics.OverRankingLegend"}}</div>
          {{/if}}
          <div class="ability-list">
            <div class="ability-characteristic-header">
              <span>{{localize "RMRPG.Item.Ability.Characteristics.CharacteristicLabel"}}</span>
              <span>{{localize "RMRPG.Item.Ability.Characteristics.LevelLabel"}}</span>
              <span>{{localize "RMRPG.Item.Ability.Characteristics.TypeLabel"}}</span>
              <span>{{localize "RMRPG.Item.Ability.Characteristics.PCLabel"}}</span>
              <span>{{localize "RMRPG.Item.Ability.Characteristics.RankLabel"}}</span>
              <span></span>
            </div>
            {{#each ability.characteristics}}
            <div class="ability-list-entry{{#if this.isRestrictionTarget}} is-restriction-target{{/if}}">
              <div class="ability-entry-row ability-entry-row--characteristic">
                <select name="system.ability.characteristics.{{@index}}.id">
                  {{selectOptions ../abilityCharacteristicOptions selected=this.id valueAttr="value" labelAttr="label"}}
                </select>
                {{#if this.isRestrictionTarget}}
                <button
                  type="button"
                  class="ability-level-display"
                  data-action="ability-characteristic-level-picker"
                  data-index="{{@index}}"
                  title="{{localize 'RMRPG.Item.Ability.Characteristics.EditLevelHint'}}"
                  aria-label="{{localize 'RMRPG.Item.Ability.Characteristics.LevelLabel'}}"
                >
                  <span class="ability-level-display-value">{{this.effectiveLevelLabel}}</span>
                </button>
                <input type="hidden" name="system.ability.characteristics.{{@index}}.level" value="{{this.level}}" />
                {{else}}
                <select name="system.ability.characteristics.{{@index}}.level">
                  {{selectOptions this.levelOptions selected=this.level valueAttr="value" labelAttr="label"}}
                </select>
                {{/if}}
                {{#if this.showTypeSelect}}
                <select name="system.ability.characteristics.{{@index}}.{{this.typeField}}">
                  {{selectOptions this.typeOptions selected=this.typeValue valueAttr="value" labelAttr="label"}}
                </select>
                {{else}}
                <span class="ability-characteristic-type-placeholder">-</span>
                {{/if}}
                <span class="ability-characteristic-meta ability-characteristic-meta--pc{{#if this.showCostDiscount}} is-discount{{/if}}">
                  {{#if this.showCostDiscount}}
                  <span class="ability-characteristic-cost-old">{{this.selectedLevelOriginalCostLabel}}</span>
                  <span class="ability-characteristic-cost-new">{{this.selectedLevelCostLabel}}</span>
                  {{else}}
                  {{this.selectedLevelCostLabel}}
                  {{/if}}
                </span>
                <span class="ability-characteristic-meta{{#if this.overRanking}} is-warning{{/if}}">{{this.selectedLevelRankLabel}}</span>
                <button
                  type="button"
                  class="ability-remove"
                  data-action="ability-characteristic-remove"
                  data-index="{{@index}}"
                  aria-label="{{localize 'RMRPG.Item.Ability.Remove'}}"
                  title="{{localize 'RMRPG.Item.Ability.Remove'}}"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            {{/each}}
            <button type="button" class="ability-add" data-action="ability-characteristic-add">
              <i class="fas fa-plus"></i>
              {{localize "RMRPG.Item.Ability.Characteristics.Add"}}
            </button>
          </div>
        </section>

        <section class="ability-section">
          <div class="ability-section-title">{{localize "RMRPG.Item.Ability.Enhancements.Title"}}</div>
          <div class="ability-list">
            {{#each ability.enhancements}}
            <div class="ability-list-entry">
              <div class="ability-entry-row">
                <select name="system.ability.enhancements.{{@index}}.id">
                  {{selectOptions ../abilityEnhancementOptions selected=this.id valueAttr="value" labelAttr="label"}}
                </select>
                <button
                  type="button"
                  class="ability-remove"
                  data-action="ability-enhancement-remove"
                  data-index="{{@index}}"
                  aria-label="{{localize 'RMRPG.Item.Ability.Remove'}}"
                  title="{{localize 'RMRPG.Item.Ability.Remove'}}"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
              {{#if this.description}}
              <div class="ability-enhancement-description{{#if this.isLongDescription}} is-collapsible{{/if}}">
                <div class="ability-enhancement-description-text">{{this.description}}</div>
                {{#if this.isLongDescription}}
                <button
                  type="button"
                  class="ability-enhancement-toggle"
                  data-action="ability-enhancement-toggle"
                  aria-expanded="false"
                  aria-label="{{localize 'RMRPG.Item.Ability.Enhancements.ToggleDescription'}}"
                >
                  <i class="fas fa-chevron-down"></i>
                </button>
                {{/if}}
              </div>
              {{/if}}
              {{#if this.requirementWarning}}
              <div class="ability-enhancement-requirement-warning">{{this.requirementWarning}}</div>
              {{/if}}
            </div>
            {{/each}}
            <button type="button" class="ability-add" data-action="ability-enhancement-add">
              <i class="fas fa-plus"></i>
              {{localize "RMRPG.Item.Ability.Enhancements.Add"}}
            </button>
          </div>
        </section>

        <section class="ability-section">
          <div class="ability-section-title">{{localize "RMRPG.Item.Ability.Restrictions.Title"}}</div>
          <div class="ability-restrictions-layout">
            <div class="ability-restrictions-description">
              {{editor
                ability.restrictions.description
                target="system.ability.restrictions.description"
                button=true
                editable=editable
                engine="prosemirror"
                placeholder=abilityRestrictionsPlaceholder
                class="ability-restrictions-editor"
              }}
            </div>
            <div class="ability-restrictions-controls">
              <div class="ability-field-group ability-field-group--inline-title">
                <div class="ability-section-title">{{localize "RMRPG.Item.Ability.Restrictions.Advances"}}</div>
                <input
                  type="number"
                  name="system.ability.restrictions.advances"
                  value="{{ability.restrictions.advances}}"
                  min="0"
                  step="1"
                />
              </div>
              <div class="ability-field-group">
                <div class="ability-section-title">{{localize "RMRPG.Item.Ability.Restrictions.TargetLabel"}}</div>
                <select name="system.ability.restrictions.advancesTarget">
                  <option value="">{{localize "RMRPG.Item.Ability.Restrictions.TargetPlaceholder"}}</option>
                  {{selectOptions abilityRestrictionTargets selected=ability.restrictions.advancesTarget valueAttr="value" labelAttr="label"}}
                </select>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
    <div class="tab" data-group="ability" data-tab="additional-settings">
      <div class="ability-details ability-details--additional">
        {{#if abilityFeatureState.hasAttack}}
        <section class="ability-section">
          <div class="ability-section-title">{{localize "RMRPG.Item.Ability.AdditionalSettings.Attack.Title"}}</div>
          <label class="ability-toggle-row">
            <input type="checkbox" name="system.abilityConfig.attack.useOverride" {{checked abilityAdditionalSettings.attack.useOverride}} />
            <span>{{localize "RMRPG.Item.Ability.AdditionalSettings.Attack.OverrideToggle"}}</span>
          </label>
          <div class="ability-field ability-field--inline">
            <div class="ability-field-group">
              <label>{{localize "RMRPG.Item.Ability.AdditionalSettings.Attack.Attribute"}}</label>
              <select name="system.abilityConfig.attack.attribute">
                {{selectOptions abilityAttackAttributeOptions selected=abilityAdditionalSettings.attack.attribute valueAttr="value" labelAttr="label"}}
              </select>
            </div>
            <div class="ability-field-group">
              <label>{{localize "RMRPG.Item.Ability.AdditionalSettings.Attack.ManualBonus"}}</label>
              <input
                type="number"
                name="system.abilityConfig.attack.manualBonus"
                value="{{abilityAdditionalSettings.attack.manualBonus}}"
                step="1"
              />
            </div>
          </div>

          <div class="ability-list">
            {{#each abilityAdditionalSettings.attack.bonuses}}
            <div class="ability-list-entry">
              <div class="ability-entry-row ability-entry-row--triple">
                <input
                  type="text"
                  name="system.abilityConfig.attack.bonuses.{{@index}}.label"
                  value="{{this.label}}"
                  placeholder="{{localize 'RMRPG.Item.Ability.AdditionalSettings.BonusLabel'}}"
                />
                <input
                  type="number"
                  name="system.abilityConfig.attack.bonuses.{{@index}}.value"
                  value="{{this.value}}"
                  step="1"
                />
                <button
                  type="button"
                  class="ability-remove"
                  data-action="ability-attack-bonus-remove"
                  data-index="{{@index}}"
                  aria-label="{{localize 'RMRPG.Item.Ability.Remove'}}"
                  title="{{localize 'RMRPG.Item.Ability.Remove'}}"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            {{/each}}
            <button type="button" class="ability-add" data-action="ability-attack-bonus-add">
              <i class="fas fa-plus"></i>
              {{localize "RMRPG.Item.Ability.AdditionalSettings.Attack.AddBonus"}}
            </button>
          </div>
        </section>
        {{/if}}

        {{#if abilityFeatureState.hasSecondary}}
        <section class="ability-section">
          <div class="ability-section-title">{{localize "RMRPG.Item.Ability.AdditionalSettings.Secondary.Title"}}</div>
          <div class="ability-field ability-field--inline">
            <div class="ability-field-group">
              <label>{{localize "RMRPG.Item.Ability.AdditionalSettings.Secondary.Attribute"}}</label>
              <select name="system.abilityConfig.secondary.attribute">
                {{selectOptions abilitySecondaryAttributeOptions selected=abilityAdditionalSettings.secondary.attribute valueAttr="value" labelAttr="label"}}
              </select>
            </div>
            <div class="ability-field-group">
              <label>{{localize "RMRPG.Item.Ability.AdditionalSettings.Secondary.ManualDc"}}</label>
              <input
                type="number"
                name="system.abilityConfig.secondary.manualDc"
                value="{{abilityAdditionalSettings.secondary.manualDc}}"
                step="1"
              />
            </div>
          </div>
          <label class="ability-toggle-row">
            <input type="checkbox" name="system.abilityConfig.secondary.manualDcEnabled" {{checked abilityAdditionalSettings.secondary.manualDcEnabled}} />
            <span>{{localize "RMRPG.Item.Ability.AdditionalSettings.Secondary.UseManualDc"}}</span>
          </label>
        </section>
        {{/if}}

        {{#if abilityFeatureState.hasDestruction}}
        <section class="ability-section">
          <div class="ability-section-title">{{localize "RMRPG.Item.Ability.AdditionalSettings.Damage.Title"}}</div>
          <label class="ability-toggle-row">
            <input type="checkbox" name="system.abilityConfig.damage.useOverride" {{checked abilityAdditionalSettings.damage.useOverride}} />
            <span>{{localize "RMRPG.Item.Ability.AdditionalSettings.Damage.OverrideToggle"}}</span>
          </label>
          <div class="ability-field ability-field--inline">
            <div class="ability-field-group">
              <label>{{localize "RMRPG.Item.Ability.AdditionalSettings.Damage.Formula"}}</label>
              <input
                type="text"
                name="system.abilityConfig.damage.formula"
                value="{{abilityAdditionalSettings.damage.formula}}"
                placeholder="1d6"
              />
            </div>
            <div class="ability-field-group">
              <label>{{localize "RMRPG.Item.Ability.AdditionalSettings.Damage.Type"}}</label>
              <select name="system.abilityConfig.damage.type">
                {{selectOptions abilityDamageTypeOptions selected=abilityAdditionalSettings.damage.type valueAttr="value" labelAttr="label"}}
              </select>
            </div>
          </div>

          <div class="ability-list">
            {{#each abilityAdditionalSettings.damage.bonuses}}
            <div class="ability-list-entry">
              <div class="ability-entry-row ability-entry-row--triple">
                <input
                  type="text"
                  name="system.abilityConfig.damage.bonuses.{{@index}}.formula"
                  value="{{this.formula}}"
                  placeholder="1d4"
                />
                <select name="system.abilityConfig.damage.bonuses.{{@index}}.type">
                  {{selectOptions ../abilityDamageTypeOptions selected=this.type valueAttr="value" labelAttr="label"}}
                </select>
                <button
                  type="button"
                  class="ability-remove"
                  data-action="ability-damage-bonus-remove"
                  data-index="{{@index}}"
                  aria-label="{{localize 'RMRPG.Item.Ability.Remove'}}"
                  title="{{localize 'RMRPG.Item.Ability.Remove'}}"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            {{/each}}
            <button type="button" class="ability-add" data-action="ability-damage-bonus-add">
              <i class="fas fa-plus"></i>
              {{localize "RMRPG.Item.Ability.AdditionalSettings.Damage.AddBonus"}}
            </button>
          </div>
        </section>
        {{/if}}

        {{#unless abilityFeatureState.hasAttack}}
        {{#unless abilityFeatureState.hasSecondary}}
        {{#unless abilityFeatureState.hasDestruction}}
        <section class="ability-section">
          <div class="ability-section-title">{{localize "RMRPG.Item.Ability.AdditionalSettings.NoneTitle"}}</div>
          <div class="ability-category-empty">{{localize "RMRPG.Item.Ability.AdditionalSettings.NoneDescription"}}</div>
        </section>
        {{/unless}}
        {{/unless}}
        {{/unless}}
      </div>
    </div>
  </div>
</div>
